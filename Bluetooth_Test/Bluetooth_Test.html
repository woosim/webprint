<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0" content=text/html;charset=UTF-8 meta http-equiv="Content-Type"/>

<style>
    body,head{color:#666;font:14px "Roboto", sans-serif;-webkit-font-smoothing:antialiased;background-color:#eee}
</style>
<html>
    <head>
        <script type="text/javascript" charset="utf-8" src='../js/jquery-1.11.1.min.js'></script>
        <script type="text/javascript" charset="utf-8" src='../js/WSEncoder-1.0.0.min.js'></script>
        <script type="text/javascript" charset="utf-8" src='../js/WSComm-1.0.0.min.js'></script>
        <style type="text/css"> @import url("../css/style.css");</style>
    </head>
   
    <body>
        <p align="center"><button id="connect_test" class="buttons">Scan Device</button></p>
        <br/>
        <p align="center"><button id="disconnect_test" class="buttons">Disconnect Device</button></p>
        <br/>
        <p align="center" id="result"></p>
        <br/>
        <br/><br/><br/><br/><br/><br/><br/><br/><br/><p align="center" id="target">Debug Text</p>
        
        <script type="text/javascript" charset="utf-8">

        var finishedCallback = function(result){
            var code = result['ERR_CODE'];
            switch(code)
            {
                case "0": 
                    alert("Success");
                    break;
                case "1": 
                    alert("Printer is not connected.");
                    break;
                case "4": 
                    alert("Session is not opened.");
                    break;
                default:
                    break;
            }
        };
          
        var connect = document.querySelector('#connect_test');
        var disconnect = document.querySelector('#disconnect_test');
        var target = document.querySelector('#target');
        var printCharacteristic = null;
        var BluetoothDevice = null;
            
        function sendTextData() {
          let encoder = new TextEncoder("utf-8");
          let text = "test";
          var buffer = new ArrayBuffer(12);
          var view = new DataView(buffer);
          view[0] = 0;
            
          printCharacteristic.writeValue(text).then(() => {
            target.innerText = 'sendTextData test';
            console.log('sendTextData test' + view);
          })
          .catch(error => { 
            console.log(error);
            target.innerText = error;
          });
        }
            
        connect.addEventListener('click', function() {
            target.innerText = 'scan device...';
            console.log('scan device...');
            navigator.bluetooth.requestDevice({
                //acceptAllDevices: true,
                filters:[{
                    name:'WOOSIM-BLE'
                }],
                optionalServices: ['a9fe5e12-de71-4020-b2cf-8bf764fb0a8d']
            })
            .then(device => {
                console.log('Connecting to GATT Server...');
                BluetoothDevice = device;
                BluetoothDevice.gatt.connect();
                
                console.log('device.name      : ' + device.name);
                console.log('device.id        : ' + device.id);
                console.log('device.connected : ' + device.connected);
                
                target.innerText = 'connect() success';
                console.log('Connect() success');
            })
            .then(server => {
                console.log('Getting GAP Service...');
                return server.getPrimaryService('generic_access');
            })
            .then(service => {
                console.log('Getting GAP Characteristics...');
                return service.getCharacteristics();
            })
            .then(characteristic => {
                target.innerText = 'characteristic test';
                console.log('characteristic test');
                printCharacteristic = characteristic;
                sendTextData();
            })
            .catch(error => { 
                console.log(error);
                target.innerText = error;
            });
        });
            
        disconnect.addEventListener('click', function() {
            if(!BluetoothDevice) {
                target.innerText = 'false';
                console.log('false');
            }
            if(BluetoothDevice.gatt.connected) {
                BluetoothDevice.gatt.disconnect();
                target.innerText = 'disconnect device';
                console.log('disconnect device');
            } else {
                target.innerText = 'Bluetooth Device is already disconnected';
                console.log('Bluetooth Device is already disconnected');
            }
        });
            
        </script>
    </body>
</html>
