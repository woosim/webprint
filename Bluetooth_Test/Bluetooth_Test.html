<!DOCTYPE html>
<meta name="viewport" content="width=device-width, initial-scale=1.0" content=text/html;charset=UTF-8 meta http-equiv="Content-Type"/>

<style>
    body,head{color:#666;font:14px "Roboto", sans-serif;-webkit-font-smoothing:antialiased;background-color:#eee}
</style>

<html>
    <head>
        <script type="text/javascript" charset="utf-8" src='../js/jquery-1.11.1.min.js'></script>
        <script type="text/javascript" charset="utf-8" src='../js/WSEncoder-1.0.0.min.js'></script>
        <script type="text/javascript" charset="utf-8" src='../js/WSComm-1.0.0.min.js'></script>
        <style type="text/css"> @import url("../css/style.css");</style>
    </head>
   
    <body>
        <p align="center"><button id="scan" class="buttons">Scan Device</button></p>
        <p align="center"><button id="printtext" class="buttons">Print Text</button></p>
        <p align="center"><input id="file" type="file""/></p> <!--onchange="onImageChange(event)-->
        <p align="center"><button id="printimage" class="buttons">Print Image</button></p>
        <p align="center"><button id="disconnect" class="buttons">Disconnect Device</button></p>
        
        <br/><br/><br/><br/><p align="center" id="debug">Debug Text</p>
        <!--<p align="center"><image id="logo" src="./img/Logo1.png"></img>-->
        
        <script type="text/javascript" charset="utf-8">
          
        let connect = document.querySelector('#scan');
        let printtext = document.querySelector('#printtext');
        let printimage = document.querySelector('#printimage');
        let disconnect = document.querySelector('#disconnect');
        let debug = document.querySelector('#debug');
        let logo = document.querySelector('#logo');
        let printCharacteristic = null;
        let BluetoothDevice = null;
        
        let woosim = new Uint8Array([0x57, 0x6F, 0x6F, 0x73, 0x69, 0x6D, 0x20, 0x53, 0x79, 0x73, 0x74, 0x65, 0x6D]);
        let test = new Uint8Array([0x54, 0x68, 0x69, 0x73, 0x20, 0x69, 0x73, 0x20, 0x74, 0x65, 0x73, 0x74, 0x2E]);
        let LF = new Uint8Array([0x0A, 0x0A, 0x0A]);
        
        /* 2022.03.10 image test ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */
        let index=0;
        let image;
        document.querySelector('#file').addEventListener('change', function(e) {
            let file = e.target.files;
            console.log(file);
            console.log(file[0]);
            var reader = new FileReader();
            reader.readAsArrayBuffer(e.target.files[0]);
            reader.onload = function(e) {
                //console.log(e.target.files[0]);
                console.log(e.target.result);
                console.log(reader);
                reader.result = new ArrayBuffer(reader.length);
                console.log(reader.result);
                image = new Uint8Array(reader.result);
                console.log(image);
                console.log(image.length);
            }
        });
        async function PrintImage() {
            if (index + 32 < image.length) {
                let temp = image.slice(index, index + 32);
                console.log(temp);
                console.log(temp.length);
                await printCharacteristic.writeValue(temp)
                    .then(() => {
                        this.delayPromise(100);
                        index += 32;
                        PrintImage();
                    })
                    .catch(error => { 
                        console.log(error);
                        debug.innerText = error;
                    });
            } else {
                if (index < image.length) {
                    let temp = image.slice(index, image.length);
                    console.log(temp);
                    console.log(temp.length);
                    await printCharacteristic.writeValue(temp)
                        .then(() => {
                            this.delayPromise(100);
                        })
                        .catch(error => { 
                            console.log(error);
                            debug.innerText = error;
                        });
                }
                await printCharacteristic.writeValue(LF)
                    .then(() => this.delayPromise(100))
                    .catch(error => { 
                        console.log(error);
                        debug.innerText = error;
                    });
            }
        }
        /* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 2022.03.10 image test */
            
        /* 2022.03.04 image test ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
        function onImageChange(event) {
            let imageFile = URL.createObjectURL(event.target.files[0]);
            createImage(imageFile, convertImage());
        }
        function createImage(imageFile, callback) {
            let image = document.createElement('img');
            image.onload = () => callback(image);
            image.setAttribute('src', imageFile);
        }
        function convertImage(image) {
            let canvas = drawImageToCanvas(image);
            let ctx = canvas.getContext('2d');
            let result = [];
            
            for(let y = 0; y < canvas.height; y ++) {
                result.push([]);
                for(let x = 0; x < canvas.width; x++) {
                    let data = ctx.getImageData(x,y,1,1).data;
                    result[y].push(data[0]);
                    result[y].push(data[1]);
                    result[y].push(data[2]);
                    result = new Uint8Array(result);
                }
            }
        }
        function drawImageToCanvas(image) {
            let canvas = document.createElement('canvas');
            canvas.width = image.width;
            canvas.height = image.height;
            canvas.getContext('2d').drawImage(image,0,0,image.width, image.height);
            return canvas;
        }
        async function PrintImage() {
            await printCharacteristic.writeValue(result);
            await printCharacteristic.writeValue(LF)
                .then(() => this.delayPromise(100))
                .catch(error => { 
                    console.log(error);
                    debug.innerText = error;
                });
        }
         2022.03.04 image test ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ */
            
        /* 2022.02.09 image test ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
        async function PrintImage() {
            var canvas = document.createElement("canvas");
            canvas.width = logo.width;
            canvas.height = logo.height;
            var ctx = canvas.getContext("2d");
            ctx.drawImage(logo, 0, 0);
            var dataURL = canvas.toDataURL("image/png");
            
            var myBuffer = new ArrayBuffer();
            var str = dataURL;
            var buffer = new ArrayBuffer(str);
            for (var i = 0; i < buffer.length; i++) {
                myBuffer.push(buffer[i]);
            }
            
            let imgArray = new ArrayBuffer();
            imgArray[0] = new Image();
            imgArray[0].src = './img/Logo1.png'
            
            logo = new ArrayBuffer();
            let print = new Uint8Array(logo);
            
            await printCharacteristic.writeValue(print);
            await printCharacteristic.writeValue(LF)
                .then(() => this.delayPromise(100))
                .catch(error => { 
                    console.log(error);
                    debug.innerText = error;
                });
        }
        ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 2022.02.09 image test */
            
        /* 2022.02.07 image test ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 
        let imgArray = new ArrayBuffer();
        imgArray[0] = new Image();
        imgArray[0].src = '../img/woosim.bmp'
            
        let index = 0;
        let data;
        let image = document.querySelector('#image');
        let canvas = document.createElement('canvas');
        canvas.width = 120;
        canvas.height = 120;
        let context = canvas.getContext("2d");
        context.drawImage(image, 0, 0, canvas.width, canvas.height);
        let imageData = context.getImageData(0, 0, canvas.width, canvas.height).data;

        function getDarkPixel(x, y) {
          // Return the pixels that will be printed black
          let red = imageData[((canvas.width * y) + x) * 4];
          let green = imageData[((canvas.width * y) + x) * 4 + 1];
          let blue = imageData[((canvas.width * y) + x) * 4 + 2];
          return (red + green + blue) > 0 ? 1 : 0;
        }
        
        function getImagePrintData() {
          if (imageData == null) {
            console.log('No image to print!');
            return new Uint8Array([]);
          }
          // Each 8 pixels in a row is represented by a byte
          let printData = new Uint8Array(canvas.width / 8 * canvas.height + 8);
          let offset = 0;
          // Set the header bytes for printing the image
          printData[0] = 29;  // Print raster bitmap
          printData[1] = 118; // Print raster bitmap
          printData[2] = 48; // Print raster bitmap
          printData[3] = 0;  // Normal 203.2 DPI
          printData[4] = canvas.width / 8; // Number of horizontal data bits (LSB)
          printData[5] = 0; // Number of horizontal data bits (MSB)
          printData[6] = canvas.height % 256; // Number of vertical data bits (LSB)
          printData[7] = canvas.height / 256;  // Number of vertical data bits (MSB)
          offset = 7;
          // Loop through image rows in bytes
          for (let i = 0; i < canvas.height; ++i) {
            for (let k = 0; k < canvas.width / 8; ++k) {
              let k8 = k * 8;
              //  Pixel to bit position mapping
              printData[++offset] = getDarkPixel(k8 + 0, i) * 128 + getDarkPixel(k8 + 1, i) * 64 +
                          getDarkPixel(k8 + 2, i) * 32 + getDarkPixel(k8 + 3, i) * 16 +
                          getDarkPixel(k8 + 4, i) * 8 + getDarkPixel(k8 + 5, i) * 4 +
                          getDarkPixel(k8 + 6, i) * 2 + getDarkPixel(k8 + 7, i);
            }
          }
          return printData;
        }
            
        async function sendNextImageDataBatch() {
          // Can only write 512 bytes at a time to the characteristic
          // Need to send the image data in 512 byte batches
          if (index + 512 < data.length) {
            await printCharacteristic.writeValue(data.slice(index, index + 512)).then(() => {
              this.delayPromise(100);
              index += 512;
              sendNextImageDataBatch();
            })
            .catch(error => console.log(error));
          } else {
            // Send the last bytes
            if (index < data.length) {
              await printCharacteristic.writeValue(data.slice(index, data.length)).then(() => {
                this.delayPromise(100);
                //resolve();
              })
              .catch(error => console.log(error));
            } else {
              //resolve();
            }
          }
        }
            
        function sendImageData() {
          index = 0;
          data = getImagePrintData();
          return sendNextImageDataBatch();
        }
        /* ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~ 2022.02.07 image test */
            
        connect.addEventListener('click', function() { // Scan Button Click
            debug.innerText = 'Scanning the device...';
            console.log('Scanning the device...');
            navigator.bluetooth.requestDevice({ // Scan Device
                //acceptAllDevices: true, // No Filter All Device Scan
                filters:[{
                    name:'WOOSIM-BLE' // Name Filter 'WOOSIM-BLE'에 해당하는 Device Scan
                }],
                optionalServices: ['a9fe5e12-de71-4020-b2cf-8bf764fb0a8d'] // Printer Service UUID
            })
            .then(device => {
                BluetoothDevice = device;
                console.log('Connecting the device...');
                return BluetoothDevice.gatt.connect();
            })
            .then(server => {
                debug.innerText = 'Connection Success.';
                console.log('gatt.connect() success');
                console.log('gatt.connected : ' + BluetoothDevice.gatt.connected);
                console.log('device.name    : ' + BluetoothDevice.name);
                console.log('device.id      : ' + BluetoothDevice.id);
                
                console.log('server.getPrimaryService...');
                return server.getPrimaryService('a9fe5e12-de71-4020-b2cf-8bf764fb0a8d');
            })
            .then(service => {
                console.log('service.getCharacteristic...');
                return service.getCharacteristic('a9fe5e12-de71-4020-b2cf-8bf766fb0a8d');
            })
            .then(characteristic => {
                console.log('characteristic and send text data');
                printCharacteristic = characteristic;
                // sendTextData1(); 연결되면 Woosim System 출력
            })
            .catch(error => {
                console.log(error);
                debug.innerText = error;
            });
        });
            
        async function sendTextData1() { // Woosim System
          await printCharacteristic.writeValue(woosim);
          await printCharacteristic.writeValue(LF)
            .then(() => this.delayPromise(100))
            .catch(error => { 
                console.log(error);
                debug.innerText = error;
            });
        }
            
        printtext.addEventListener('click', function() {
            sendTextData2();
        });
        printimage.addEventListener('click', function() {
            PrintImage();
        });
                               
        async function sendTextData2() { // This is test.
          await printCharacteristic.writeValue(test);
          await printCharacteristic.writeValue(LF)
            .then(() => this.delayPromise(100))
            .catch(error => { 
                console.log(error);
                debug.innerText = error;
            });
        }
            
        function delayPromise(delay) {
            return new Promise(resolve => {
                setTimeout(resolve, delay);
            });
        }
            
        disconnect.addEventListener('click', function() { // Disconnect Button Click
            console.log(BluetoothDevice);
            if(!BluetoothDevice) {
                debug.innerText = 'No device connected.';
                console.log('No device connected.');
            }
            console.log('Disconnecting the device...');
            if(BluetoothDevice.gatt.connected) {
                BluetoothDevice.gatt.disconnect();
                debug.innerText = 'Disconnect the device.';
                console.log('Disconnect the device.');
            } else {
                debug.innerText = 'Bluetooth Device is already disconnected';
                console.log('Bluetooth Device is already disconnected');
            }
        });
            
        </script>
    </body>
</html>
