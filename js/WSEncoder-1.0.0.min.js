/*! javascript printer library v0.5.0 (c) 2018 woosimsystem, Inc. copyright */

function WSEncoder(){
    function checkRegexp(a, r){
        if(void 0 != a){
            if(!r.test(a)){ 
                throw Error(a + 'is invalid.');
            }
            return a;
        }
        return "";
    };

    function checkRange(a, b, c){
        if (void 0 != a) {
            if (a < b || a > c){
                throw Error(a + 'is invalid.');
            }
            return a;
        }
        return "";
    };

    this.setTextAlign = function(d){
        if(void 0 == d) throw Error("textAlign is undefined.");
        return "<textAlign>" + checkRegexp(d, /^(left|center|right)$/) + "</textAlign>";
    };

    this.setLeftMargin = function(d){
        if(void 0 == d) throw Error("leftMargin is undefined.");
        return "<leftMargin>" + checkRange(d, 1, 255) + "</leftMargin>";
    };

    this.setAreaWidth = function(d){
        if(void 0 == d) throw Error("areaWidth is undefined.");
        return "<areaWidth>" + checkRange(d, 1, 255) + "</areaWidth>";
    };

    this.setUpsideDown = function(d){
        if(void 0 == d) throw Error("sideDown is undefined.");
        return "<upsideDown>" + checkRegexp(d, /^(true|false)$/) + "</upsideDown>";
    };

    this.setAbsolutePosition = function(d){
        if(void 0 == d) throw Error("absolute position is undefined.");
        return "<absolutePosition>" + checkRange(d, 0, 65535) + "</absolutePosition>";
    };

    this.setFontSize = function(d){
        if(void 0 == d) throw Error("fontSize is undefined.");
        return "<fontSize>" + checkRange(d, 0, 2) + "</fontSize>";
    };

    this.setCodeTable = function(d){
        if(void 0 == d) throw Error("code table is undefined.");
        return "<codeTable>" + checkRegexp(d, /^(cp437|cp850|cp860|cp852|cp857|cp737|cp866|cp775|cp858|win1252|win1251|win1250|win1253|win1254|win1255|win1258|win1257|euc_kr|shift_jis)$/) + "</codeTable>";
    };

    this.addText = function(t){
        var xmlElement = "";
        if(t != void 0){
            xmlElement+= "<text", 
            t.emphasized != void 0? xmlElement+= (" emphasized=" + '"' + checkRegexp(t.emphasized, /^(true|false)$/) + '"'):void 0,
            t.underline != void 0? xmlElement+= (" underline=" + '"' + checkRange(t.underline, 0, 2) + '"'):void 0,
            t.lineSpace != void 0? xmlElement+= (" lineSpace=" + '"' + checkRange(t.lineSpace, 1, 255) + '"'):void 0,
            t.width != void 0? xmlElement+= (" width=" + '"' + checkRange(t.width, 1, 8) + '"'):void 0,
            t.height != void 0? xmlElement+= (" height=" + '"' + checkRange(t.height, 1, 8) + '"'):void 0,
            t.characterSpace != void 0? xmlElement+= (" characterSpace=" + '"' + checkRange(t.characterSpace, 1, 255) + '"'):void 0,
            t.reverse != void 0? xmlElement+= (" reverse=" + '"' + checkRegexp(t.reverse, /^(true|false)$/) + '"'):void 0,
            t.data != void 0 ? (xmlElement += ">", xmlElement+= t.data, xmlElement+= "</text>") : xmlElement += "/>";
            return xmlElement;
        }
        else throw Error("text is undefined.");
    };

    function calculateQuantError(o, n) {
        var oc = parseInt((o.r + o.g + o.b) / 3),
            nc = parseInt((n.r + n.g + n.b) / 3);
        return { r: oc - nc, g: oc - nc, b: oc - nc, a: n.a };
    };

    function palette(color) {
        var c = parseInt(((color.r + color.g + color.b) / 3) > 128 ? 255 : 0);
        return { r: c, g: c, b: c, a: color.a };
    };

    function contrastImage(imageData, contrast) {

        var data = imageData.data;
        var factor = (259 * (contrast + 255)) / (255 * (259 - contrast));

        for(var i=0;i<data.length;i+=4)
        {
            data[i] = factor * (data[i] - 128) + 128;
            data[i+1] = factor * (data[i+1] - 128) + 128;
            data[i+2] = factor * (data[i+2] - 128) + 128;
        }
        return imageData;
    };

    this.addCanvas = function(c){
        var xmlElement = "";
        if(void 0 != c && void 0 != c.ctx){ 
            xmlElement = "<image"; 
            var w = c.width, h = c.height;

           // console.log("add Image" ,w, h, x, y, c.dithering);

            var d = c.ctx.getImageData(c.x, c.y, w, h);
            var bytePerRow = parseInt(w/8) + ((w%8==0)? 0:1);
            var arrayCount = bytePerRow * h;

           // console.log("add Image", arrayCount);

            var buffer = new ArrayBuffer(arrayCount);
            var bufferView = new Uint8Array(buffer);
            var data = d.data;

            if(c.dithering == false){

                for(var e = 0; e < h; e++){
                    for (var l = 0 ; l < w ; l++) {
                        var byteCount = parseInt(l/8); 
                        var bitCount = parseInt(l%8);
                        var byteIndex = (e * bytePerRow) + byteCount;
                        var dataIndex = (e * w * 4) + (l * 4);


                        var gray = parseInt(data[dataIndex] * 0.21 + data[dataIndex + 1] * 0.51 + data[dataIndex + 2] * 0.07, 10);

                        if ((gray <= 128) && (data[dataIndex + 3] != 0)){
                            bufferView[byteIndex] |= 0x01 << (7 - bitCount);
                        } 
                    }
                }

            }else{

                for (var i = 0; i <= data.length; i += 4) {
                    data[i] = data[i + 1] = data[i + 2] = parseInt(data[i] * 0.21 + data[i + 1] * 0.71 + data[i + 2] * 0.07, 10);
                }

                for(var e = 0; e < h; e++){
                    for (var l = 0 ; l < w ; l++) {
                        var byteCount = parseInt(l/8); 
                        var bitCount = parseInt(l%8);
                        var byteIndex = (e * bytePerRow) + byteCount;
                        var dataIndex = (e * w * 4) + (l * 4);
                 

                        if (data[dataIndex] <= 128) {
                    
                            newPixelColour = 0;
                
                        } else {
                    
                            newPixelColour = 255;
                        }
                    
                        err = parseInt((data[dataIndex] - newPixelColour) / 8, 10);
                        data[dataIndex] = newPixelColour;
                    
                        data[dataIndex + 4]						+= err;
                        data[dataIndex + 8]						+= err;
                        data[dataIndex + (4 * w) - 4]		+= err;
                        data[dataIndex + (4 * w)]			+= err;
                        data[dataIndex + (4 * w) + 4]		+= err;
                        data[dataIndex + (8 * w)]			+= err;
                    
                        data[dataIndex + 1] = data[dataIndex + 2] = data[dataIndex];
                            
                        if ((data[dataIndex] == 0) && (data[dataIndex + 3] != 0)){
                            bufferView[byteIndex] |= 0x01 << (7 - bitCount);
                        }
                    }
                }
            }
    
            var binary = '';
            var len = buffer.byteLength;
            
            for (var i = 0; i < len; i++) {
                binary += String.fromCharCode( bufferView[ i ] );
            }
        
            return  xmlElement+= " width=" + '"' + checkRange(w, 1, 65535) + '"', 
            xmlElement+= " height=" + '"' + checkRange(h, 1, 65535) + '">',
            xmlElement+= window.btoa( binary ),
            xmlElement+= "</image>";
            return xmlElement;
        }else throw Error("image is undefined.");
    };

    this.addBarcode = function (b) {
        var xmlElement;
        if (void 0 != b) { 
            xmlElement = "<barcode" + " type=" + '"' + checkRegexp(b.type, /^(upce|upca|ean8|ean13|code39|itf|code128|code93|codebar)$/) + '"';
            xmlElement += " width= " + '"' + checkRange(b.width, 1, 8) + '"';
            xmlElement += " hri=" + '"' + checkRegexp(b.hri, /^(false|true)$/) + '"';
            xmlElement += " height=" + '"' + checkRange(b.height, 1, 255) + '"';
            if (void 0 == b.data) throw Error('"data" is undefined.');           
            xmlElement += ">" +  b.data + "</barcode>";
            return xmlElement;
        } else throw Error("barcode is undefined.");
    };

    this.addQrCode = function (b) {
        var xmlElement;
        if (void 0 != b) {
            xmlElement = "<qrcode" + " version=" + '"' + checkRange(b.version, 0, 40) + '"';
            xmlElement += " level=" + '"' + checkRegexp(b.level, /[LMQH]/) + '"';
            xmlElement += " size=" + '"' + checkRange(b.size, 1, 8) + '"' + ">";
            if (void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement +=  b.data + "</qrcode>";
            return xmlElement;
        } else throw Error("qrcode is undefined.");
    };

    this.addPDF417 = function (b) {
        var xmlElement="";
        if(void 0 != b) {
            xmlElement = "<pdf417" + " column=" + '"' + checkRange(b.column, 1, 30) + '"';
            xmlElement += " level=" + '"' + checkRange(b.level, 0, 8) + '"';
            xmlElement += " ratio=" + '"' + checkRange(b.ratio,2, 5) + '"' + ">";
            if (void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement += b.data + "</pdf417>";
            return xmlElement;
        } else throw Error("pdf417 is undefined");
    };

    this.addDataMatrix = function (b) {
        var xmlElement="";
        if(void 0 != b){
            xmlElement = "<dataMatrix" + " height=" + '"' + b.height + '"';
            xmlElement += " width=" + '"' + b.width + '"';
            xmlElement += " moduleSize=" + '"' + checkRange(b.moduleSize, 1, 8) + '"' + ">";
            if(void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement += b.data + "</dataMatrix>"; 
            return xmlElement; 
        }else throw Error("dataMatrix is undefined");
    };

    this.addMicroPDF417 = function (b) {
        var xmlElement="";
        if(void 0 != b) {
            xmlElement = "<microPdf417" + " column=" + '"' + checkRange(b.column, 1, 4) + '"';
            xmlElement += " row=" + '"' + b.row == 0? 0:checkRange(b.row, 4, 44) + '"';
            xmlElement += " ratio=" + '"' + checkRange(b.ratio,2, 5) + '"' + ">";
            if (void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement += b.data + "</microPdf417>";
            return xmlElement;
        } else throw Error("microPdf417 is undefined");
    };

    this.addTruncPDF417 = function (b) {
        var xmlElement="";
        if(void 0 != b) {
            xmlElement = "<truncPdf417" + " column=" + '"' + checkRange(b.column, 1, 4) + '"';
            xmlElement += " level=" + '"' + b.level == 0? 0:checkRange(b.level, 0, 8) + '"';
            xmlElement += " ratio=" + '"' + checkRange(b.ratio,2, 5) + '"' + ">";
            if (void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement += b.data + "</truncPdf417>";
            return xmlElement;
        } else throw Error("truncPdf417 is undefined");
    };

    this.addMaxicode = function (b) {
        var xmlElement="";
        if(void 0 != b){
            xmlElement = "<maxicode" + " mode=" + '"' + checkRange(b.mode, 2, 6) + ">";
            if(void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement += b.data + "</maxicode>";
            return xmlElement;
        } else throw Error("maxicode is undefined");
    };

    this.addGS1Databar = function (b) {
        var xmlElement="";
        if(void 0 != b){
            xmlElement = "<gs1databar" + " type=" + '"' + checkRange(b.type, 0, 6) + '"';
            xmlElement += " segment=" + '"' + checkRange(b.segment, 2, 20) + '"'; + ">";
            if(void 0 == b.data) throw Error('"data" is undefined.');
            xmlElement += b.data + "</gs1databar>";
            return xmlElement;
        } else throw Error("gs1databar is undefined");
    };

    this.setPrintMode = function(m){
        if(m == void 0) throw Error("PrintMode is undefined.");
        return "<mode>" + checkRegexp(m, /^(page|standard)$/) + "</mode>";
    };

    this.setCutting = function(d){
        if(void 0 == d) throw Error("cutting mode is undefined.");
        return "<cutting>" + checkRange(d, 0, 1) + "</cutting>";
    };

    this.addNewLine = function(){
        return "<newLine/>";
    };

    this.addFeedNDot = function(d){
        if(void 0 == d) throw Error("dot is undefined.");
        return "<feedNDot>" + checkRange(d, 1, 255) + "</feedNDot>";
    };

    this.addFeedNLine = function(d){
        if(void 0 == d) throw Error("line is undefined.");
        return "<feedNLine>" + checkRange(d, 1, 255) + "</feedNLine>";
    };

    this.setFeedToMark = function(){
        return "<feedToMark/>";
    };

    this.pm_setPrintingArea = function (a) {
        var xmlElement = "";
        if(void 0 != a){
            xmlElement = "<printingArea" + " x=" + '"' + checkRange(a.x, 0, 65535) + '"';
            xmlElement += " y=" + '"' + checkRange(a.y, 0, 65535) + '"';
            xmlElement += " width=" + '"' + checkRange(a.width, 0, 65535) + '"';
            xmlElement += " height=" + '"' + checkRange(a.height, 0, 65535) + '"' + " />";
            return xmlElement;
        } else throw Error("printing area is undefined");
    };

    this.pm_addBox = function (d) {
        var xmlElement = "";
        if(void 0 != d){
            xmlElement = "<box" + " x=" + '"' + checkRange(d.x, 0, 65535) + '"';
            xmlElement += " y=" + '"' + checkRange(d.y, 0, 65535) + '"';
            xmlElement += " width=" + '"' + checkRange(d.width, 0, 65535) + '"';
            xmlElement += " height=" + '"' + checkRange(d.height, 0, 65535) + '"';
            xmlElement += " thickness=" + '"' + checkRange(d.thickness, 0, 255) + '"' + " />";
            return xmlElement;
        }
    };

    this.pm_setDirection = function(d){
        if(void 0 == d) throw Error("direction is undefined.");
        return "<direction>" + checkRegexp(d, /^(lefttoright|bottomtotop|righttoleft|toptobottom)$/) + "</direction>";
    };

    this.pm_setPosition = function(d){
        var xmlElement = "";
        if(void 0 != d){
            xmlElement+= "<position",
            xmlElement+= (" x=" + '"' + checkRange(d.x, 0, 65535) + '"'),
            xmlElement+= (" y=" + '"' + checkRange(d.y, 0, 65535) + '"'),
            xmlElement+= "/>";
            return xmlElement;
        }else throw Error("position is undefied.");
    };
};
